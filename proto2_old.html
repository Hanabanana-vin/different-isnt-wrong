<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Different is not wrong â€“ Stress Rhythm Check</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat+Alternates:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
 
</head>
<body>
  <div class="shell">

    <!-- INTRO -->
    <div class="card" id="screen-intro">
      <div class="tagline">Different is not wrong</div>
      <h1 class="intro_h1">Take care of your mental health</h1>
      <p>
         Check your stress levels quickly and easily, and restore your mental wellbeing.
      </p>
      <div class="btn-row">
        <button class="primary" id="btn-start">Start Stress Check</button>
      </div>
    </div>

    <!-- Q1 -->
    <div class="card" id="q1" style="display:none;">
      <div class="top-nav">
        <button class="back-btn" id="back-q1">â† Back</button>
        <div class="progress-bar"><div class="fill" style="width:33%;"></div></div>
      </div>
      <div class="step-label">Question 1 of 3</div>
      <h2>Which side do you think my political leanings fall on?</h2>
      <p>Please answer honestly, just as you normally think.</p>
      <div class="options-block">
        <div class="opt" data-key="politics">Left</div>
        <div class="opt" data-key="politics">Right</div>
        <div class="opt" data-key="politics">Center</div>
        <div class="opt" data-key="politics">â€œToo radicalâ€</div>
        <div class="opt" data-key="politics">â€œToo quietâ€</div>
      </div>
    </div>

    <!-- Q2 -->
    <div class="card" id="q2" style="display:none;">
      <div class="top-nav">
        <button class="back-btn" id="back-q2">â† Back</button>
        <div class="progress-bar"><div class="fill" style="width:66%;"></div></div>
      </div>
      <div class="step-label">Question 2 of 3</div>
      <h2>When it comes to gender, you feelâ€¦</h2>
      <p>Please answer honestly, just as you normally think.</p>
      <div class="options-block">
        <div class="opt" data-key="gender">Very clearly defined</div>
        <div class="opt" data-key="gender">Somewhere in between</div>
        <div class="opt" data-key="gender">Questioned or judged</div>
        <div class="opt" data-key="gender">I donâ€™t want to answer</div>
      </div>
    </div>

    <!-- Q3 -->
    <div class="card" id="q3" style="display:none;">
      <div class="top-nav">
        <button class="back-btn" id="back-q3">â† Back</button>
        <div class="progress-bar"><div class="fill" style="width:100%;"></div></div>
      </div>
      <div class="step-label">Question 3 of 3</div>
      <h2>Has your race ever made you feel excluded or treated unfairly?</h2>
      <p>Please answer honestly, just as you normally think.</p>
      <div class="options-block">
        <div class="opt" data-key="identity">No, never</div>
        <div class="opt" data-key="identity">Sometimes</div>
        <div class="opt" data-key="identity">Quite often</div>
        <div class="opt" data-key="identity">All the time</div>
      </div>
    </div>

    <!-- STEP 2: MEASURE -->
    <div class="card" id="screen-measure" style="display:none;">
      <div class="step-label">Step 2 Â· Heart rhythm capture</div>
      <div class="center">
        <h2>We are listening to your rhythmâ€¦</h2>
        <p>Breathe in and out comfortably.</p>

        <div class="camera-wrap" id="camera-wrap">
          <video id="cam" autoplay playsinline></video>
        </div>
        <p class="tiny">Gently cover the camera with your fingertip and stay still for a moment.</p>
        <p class="tiny" id="signal-status"></p>

        <div class="loader"></div>
        <div class="scan-percent" id="scan-percent">Requesting camera permissionâ€¦</div>

        <!-- ì‹¤ì‹œê°„ ì‹¬ë°• ê·¸ë˜í”„ -->
        <canvas id="graph" width="320" height="80"
          style="
            margin-top:16px;
            width:100%;
            max-width:360px;
            height:80px;
            border-radius:10px;
            background:rgba(0,0,0,0.24);
          "></canvas>

        <p class="tiny">
          This heartbeat is estimated from tiny light changes on your fingertip.  
          It is not a medical measurement, but a way to visualize your rhythm.
        </p>
      </div>
    </div>

    <!-- STEP 3: RESULT -->
    <div class="card" id="screen-result" style="display:none;">
      <div class="step-label">Step 3 Â· Result</div>
        <h2>Your heart answered first.</h2>
        <p>Based on your reactions, this is how your rhythm looked in that moment.</p>

        <div class="center">
          <div class="result-bpm" id="result-bpm">â€“ bpm</div>
          <div class="result-label" id="result-label">unique rhythm pattern</div>
        </div>

        <!-- Normal Range ê·¸ë˜í”„ -->
        <div class="normal-card">
          <div class="normal-title">Normal Range</div>
          <div class="normal-sub">
            A wide band where different rhythms still belong together.
          </div>
        
          <div class="normal-graph-wrap">
            <svg class="normal-graph" viewBox="0 0 100 40" preserveAspectRatio="none">
        
              <!-- ë²”ìœ„ ì˜ì—­ -->
              <path class="normal-area"
                d="M0 32 
                   Q 20 26, 35 20 
                   Q 50 12, 65 20 
                   Q 80 26, 100 32
                   L100 40 L0 40 Z" />
        
              <!-- ê³¡ì„  ë¼ì¸ -->
              <path class="normal-line"
                d="M0 32 
                   Q 20 26, 35 20 
                   Q 50 12, 65 20 
                   Q 80 26, 100 32" />
        
              <!-- NORMAL RANGE ê²½ê³„(ë°•ìŠ¤ ì–‘ìª½ 10%) -->
              <line x1="10" y1="10" x2="10" y2="36" class="normal-boundary"/>
              <line x1="90" y1="10" x2="90" y2="36" class="normal-boundary"/>
        
              <!-- ë‚´ ìœ„ì¹˜ (JSì—ì„œ xë§Œ ì¡°ì •) -->
              <line id="nr-marker-line" x1="50" x2="50" y1="8" y2="36" class="nr-marker-line"/>
              <circle id="nr-marker-dot" cx="50" cy="12" r="1.8" class="nr-marker-dot"/>
              <text id="nr-marker-label" x="50" y="6" class="nr-marker-label">My position</text>
        
            </svg>
          </div>
        
          <div class="normal-footer">
            <span class="normal-xlabel">Slower</span>
            <span class="normal-bpm" id="nr-bpm-inline">â€“ bpm</span>
            <span class="normal-xlabel">Faster</span>
          </div>
        
          <p class="normal-message">
            No matter your politics, gender or race, your heart still falls inside this wide normal range.  
            <strong>Different is not wrong.</strong>
          </p>
        </div>
        

        <div class="btn-row">
          <button id="btn-restart">Try again</button>
        </div>

    </div>
    
    

    <!-- PPG ë¶„ì„ìš© ìˆ¨ì€ ìº”ë²„ìŠ¤ -->
    <canvas id="ppg-canvas" width="64" height="48" style="display:none;"></canvas>

  </div>

  <script>
    // í™”ë©´ ìš”ì†Œë“¤
    const intro = document.getElementById('screen-intro');
    const q1 = document.getElementById('q1');
    const q2 = document.getElementById('q2');
    const q3 = document.getElementById('q3');
    const mScreen = document.getElementById('screen-measure');
    const rScreen = document.getElementById('screen-result');

    const btnStart = document.getElementById('btn-start');
    const btnRestart = document.getElementById('btn-restart');

    const backQ1 = document.getElementById('back-q1');
    const backQ2 = document.getElementById('back-q2');
    const backQ3 = document.getElementById('back-q3');

    const ring = document.getElementById('heart-ring');
    const particlesWrap = document.getElementById('heart-particles');
    const bpmEl = document.getElementById('result-bpm');
    const labelEl = document.getElementById('result-label');
    const quoteEl = document.getElementById('result-quote');

    const nrMarkerLine  = document.getElementById("nr-marker-line");
    const nrMarkerDot   = document.getElementById("nr-marker-dot");
    const nrMarkerLabel = document.getElementById("nr-marker-label");
    const nrBpmInline   = document.getElementById("nr-bpm-inline");


    const scanPercentEl = document.getElementById('scan-percent');
    const signalStatusEl = document.getElementById('signal-status');
    const camWrap = document.getElementById('camera-wrap');
    const video = document.getElementById('cam');

    const ppgCanvas = document.getElementById('ppg-canvas');
    const ppgCtx = ppgCanvas.getContext('2d');

    const graphCanvas = document.getElementById('graph');
    const graphCtx = graphCanvas.getContext('2d');

    const distPercentEl   = document.getElementById('dist-percent');
    const distMarkerLine  = document.getElementById('dist-marker-line');
    const distMarkerDot   = document.getElementById('dist-marker-dot');


    function updateNormalMarker(bpm) {
  const normalMin = 50;
  const normalMax = 120;
  const range = normalMax - normalMin;

  const clamped = Math.max(normalMin, Math.min(normalMax, bpm));
  const t = (clamped - normalMin) / range; // 0~1

  // boundary: 10% ~ 90%
  const x = 10 + t * 80;

  nrMarkerLine.setAttribute("x1", x);
  nrMarkerLine.setAttribute("x2", x);
  nrMarkerDot.setAttribute("cx", x);
  nrMarkerLabel.setAttribute("x", x);

  nrBpmInline.textContent = `${bpm} bpm`;}

    let camStream = null;
    let scanAnimFrame = null;

    // PPG ìˆ˜ì§‘ìš©
    let ppgData = [];     // {t, v}
    let ppgFrameHandle = null;
    let ppgStartTime = 0;

    let graphData = [];
    const QUALITY_WIN = 40;
    let qualityWindow = [];
    let signalOk = false;
    let ppgMode = false;

    let scanProgress = 0;

    let answers = {
      politics: null,
      gender: null,
      identity: null,
    };

    function show(screen) {
      intro.style.display = 'none';
      q1.style.display = 'none';
      q2.style.display = 'none';
      q3.style.display = 'none';
      mScreen.style.display = 'none';
      rScreen.style.display = 'none';
      screen.style.display = 'block';
    }

    btnStart.onclick = () => show(q1);

    // ë’¤ë¡œê°€ê¸°
    backQ1.onclick = () => show(intro);
    backQ2.onclick = () => show(q1);
    backQ3.onclick = () => show(q2);

    // ì§ˆë¬¸ ì„ íƒ
    q1.querySelectorAll('.opt').forEach(opt => {
      opt.addEventListener('click', () => {
        answers.politics = opt.textContent.trim();
        q1.querySelectorAll('.opt').forEach(o => o.classList.remove('selected'));
        opt.classList.add('selected');
        show(q2);
      });
    });

    q2.querySelectorAll('.opt').forEach(opt => {
      opt.addEventListener('click', () => {
        answers.gender = opt.textContent.trim();
        q2.querySelectorAll('.opt').forEach(o => o.classList.remove('selected'));
        opt.classList.add('selected');
        show(q3);
      });
    });

    q3.querySelectorAll('.opt').forEach(opt => {
      opt.addEventListener('click', () => {
        answers.identity = opt.textContent.trim();
        q3.querySelectorAll('.opt').forEach(o => o.classList.remove('selected'));
        opt.classList.add('selected');
        show(mScreen);
        startCamera();
      });
    });

    // ì¹´ë©”ë¼ + PPG
    async function startCamera() {
      scanPercentEl.textContent = "Requesting camera permissionâ€¦";
      signalStatusEl.textContent = "";
      scanProgress = 0;
      try {
        camStream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = camStream;
        ppgMode = true;
        startPPG();
        startScanAnimation();
      } catch (e) {
        console.warn("Camera error:", e);
        ppgMode = false;
        signalStatusEl.textContent = "Camera unavailable. We will simulate your rhythm.";
        startScanAnimation();
      }
    }

    function stopCamera() {
      if (!camStream) return;
      camStream.getTracks().forEach(t => t.stop());
      camStream = null;
      video.srcObject = null;
    }

    // PPG ìˆ˜ì§‘ ì‹œì‘
    function startPPG() {
      ppgData = [];
      graphData = [];
      qualityWindow = [];
      signalOk = false;
      ppgStartTime = performance.now();

      function capture(now) {
        if (!video.videoWidth || !video.videoHeight) {
          ppgFrameHandle = requestAnimationFrame(capture);
          return;
        }
        const w = ppgCanvas.width;
        const h = ppgCanvas.height;
        ppgCtx.drawImage(video, 0, 0, w, h);
        const frame = ppgCtx.getImageData(0, 0, w, h).data;
        let sum = 0;
        let count = 0;
        const startX = Math.floor(w * 0.25);
        const endX   = Math.floor(w * 0.75);
        const startY = Math.floor(h * 0.25);
        const endY   = Math.floor(h * 0.75);

        for (let y = startY; y < endY; y++) {
          for (let x = startX; x < endX; x++) {
            const idx = (y * w + x) * 4;
            const r = frame[idx]; // R ì±„ë„
            sum += r;
            count++;
          }
        }
        const avg = sum / count;
        const t = (now - ppgStartTime) / 1000;
        ppgData.push({ t, v: avg });

        // í’ˆì§ˆ í‰ê°€ìš© ìœˆë„ìš°
        qualityWindow.push(avg);
        if (qualityWindow.length > QUALITY_WIN) qualityWindow.shift();
        if (qualityWindow.length >= QUALITY_WIN) {
          let qMin = Infinity, qMax = -Infinity;
          for (const v of qualityWindow) {
            if (v < qMin) qMin = v;
            if (v > qMax) qMax = v;
          }
          const amp = qMax - qMin; // ë³€í™”í­
          if (amp < 2) {
            // ê±°ì˜ ë³€ë™ ì—†ìŒ â†’ ì†ê°€ë½ ì•ˆ ê°€ë ¤ì§/ë„ˆë¬´ ì–´ë‘ì›€
            signalOk = false;
            signalStatusEl.textContent = "We canâ€™t clearly see your fingertip. Please fully cover the camera and stay still.";
          } else {
            signalOk = true;
            signalStatusEl.textContent = "We are detecting subtle changes in your blood flow. Keep stillâ€¦";
          }
        } else {
          signalStatusEl.textContent = "Trying to lock onto your rhythmâ€¦";
        }

        // ê·¸ë˜í”„ìš© ë°ì´í„°
        graphData.push(avg);
        if (graphData.length > 400) graphData.shift();
        drawGraph();

        ppgFrameHandle = requestAnimationFrame(capture);
      }

      if (ppgFrameHandle) cancelAnimationFrame(ppgFrameHandle);
      ppgFrameHandle = requestAnimationFrame(capture);
    }

    function stopPPG() {
      if (ppgFrameHandle) cancelAnimationFrame(ppgFrameHandle);
      ppgFrameHandle = null;
    }

    // ì‹¤ì‹œê°„ íŒŒí˜• ê·¸ë˜í”„
    function drawGraph() {
      const w = graphCanvas.width;
      const h = graphCanvas.height;
      graphCtx.clearRect(0, 0, w, h);
      if (graphData.length < 2) return;

      let gMin = Infinity, gMax = -Infinity;
      for (const v of graphData) {
        if (v < gMin) gMin = v;
        if (v > gMax) gMax = v;
      }
      const amp = gMax - gMin || 1;

      graphCtx.beginPath();
      for (let i = 0; i < graphData.length; i++) {
        const norm = (graphData[i] - gMin) / amp; // 0~1
        const x = (i / (graphData.length - 1)) * w;
        const y = h - (0.2 + norm * 0.6) * h;     // ê°€ìš´ë° ë ì— ê·¸ë¦¬ê¸°
        if (i === 0) graphCtx.moveTo(x, y);
        else graphCtx.lineTo(x, y);
      }
      graphCtx.strokeStyle = 'rgba(186,214,235,0.9)';
      graphCtx.lineWidth = 2;
      graphCtx.stroke();
    }

    // ìŠ¤ìº” ì§„í–‰ (ì‹œê°„ + ì‹ í˜¸í’ˆì§ˆ ê¸°ë°˜)
    function startScanAnimation() {
      if (scanAnimFrame) cancelAnimationFrame(scanAnimFrame);
      const start = performance.now();
      let last = start;
      scanProgress = 0;

      const TARGET = 12000; // 12ì´ˆ ì •ë„ ëª©í‘œ
      const MAX = 18000;    // ìµœì¥ 18ì´ˆ

      function tick(now) {
        const elapsed = now - start;
        const dt = now - last;
        last = now;

        if (!ppgMode) {
          // ì¹´ë©”ë¼ ì—†ëŠ” ê²½ìš°: ê·¸ëƒ¥ ì‹œê°„ ê¸°ë°˜
          scanProgress = Math.min(100, (elapsed / TARGET) * 100);
        } else {
          const baseSpeed = (dt / TARGET) * 100;
          const qualityFactor = signalOk ? 1.2 : 0.3; // í’ˆì§ˆ ë‚˜ì˜ë©´ ëŠë¦¬ê²Œ
          scanProgress = Math.min(100, scanProgress + baseSpeed * qualityFactor);

          // ë„ˆë¬´ ì˜¤ë˜ ê±¸ë¦¬ë©´ ê°•ì œë¡œ ë§ˆë¬´ë¦¬
          if (elapsed > MAX && scanProgress < 100) {
            scanProgress = Math.min(100, scanProgress + baseSpeed * 2);
          }
        }

        const pct = Math.round(Math.min(100, scanProgress));
        scanPercentEl.textContent = `Scanning your heart rhythmâ€¦ ${pct}%`;

        // ì¹´ë©”ë¼ ë§ ì†ë„ë„ ì ì  ë¹¨ë¼ì§€ê²Œ
        const progress = pct / 100;
        const duration = 1.6 - progress * 0.6; // 1.6s â†’ 1.0s
        camWrap.style.animationDuration = duration + "s";

        if (pct < 100) {
          scanAnimFrame = requestAnimationFrame(tick);
        } else {
          stopPPG();
          stopCamera();
          const measured = ppgMode ? computeBPMFromPPG(ppgData) : null;
          generateResult(measured);
          show(rScreen);
        }
      }
      scanAnimFrame = requestAnimationFrame(tick);
    }

    // PPG â†’ BPM
    function computeBPMFromPPG(data) {
      if (!data || data.length < 30) return null;

      const times = data.map(d => d.t);
      const values = data.map(d => d.v);

      const mean = values.reduce((a,b)=>a+b,0) / values.length;
      const centered = values.map(v => v - mean);
      const sq = centered.map(v => v*v);
      const std = Math.sqrt(sq.reduce((a,b)=>a+b,0) / centered.length) || 1;
      const norm = centered.map(v => v / std);

      const win = 5;
      const smooth = norm.map((v,i) => {
        let s = 0, c = 0;
        for (let k = -win; k <= win; k++) {
          const idx = i + k;
          if (idx >=0 && idx < norm.length) { s += norm[idx]; c++; }
        }
        return s / c;
      });

      const peaks = [];
      const threshold = 0.25;
      for (let i = 1; i < smooth.length - 1; i++) {
        if (smooth[i] > smooth[i-1] && smooth[i] > smooth[i+1] && smooth[i] > threshold) {
          peaks.push(i);
        }
      }
      if (peaks.length < 2) return null;

      const intervals = [];
      for (let i = 1; i < peaks.length; i++) {
        const t1 = times[peaks[i-1]];
        const t2 = times[peaks[i]];
        intervals.push(t2 - t1);
      }
      const avgInt = intervals.reduce((a,b)=>a+b,0) / intervals.length;
      if (!avgInt || avgInt <= 0) return null;

      const bpm = 60 / avgInt;
      if (bpm < 40 || bpm > 180) return null;
      return Math.round(bpm);
    }

    // ê²°ê³¼ ìƒì„±
    function generateResult(measuredBpm) {
      console.log("measuredBpm from PPG:", measuredBpm);

      let bpm;

      // 1) PPGê°€ ìˆ«ìë¥¼ ì£¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
      if (typeof measuredBpm === "number") {
        bpm = Math.max(50, Math.min(140, measuredBpm));
      } 
      // 2) ì‹¤íŒ¨í•˜ë©´ ë„“ì€ ë²”ìœ„ì—ì„œ ëœë¤
      else {
        let base = 70 + Math.floor(Math.random() * 40 - 20); // 50~90
        bpm = Math.max(50, Math.min(120, base));
      }

      // ìˆ«ì í‘œì‹œ
      bpmEl.textContent = `${bpm} bpm`;
      updateNormalMarker(bpm);
      // ë¦¬ë“¬ ë¼ë²¨
      let label;
      if (bpm < 60)      label = "slow, steady rhythm";
      else if (bpm < 80) label = "calm but reactive rhythm";
      else if (bpm < 95) label = "sensitive, responsive rhythm";
      else               label = "intense, over-alert rhythm";
      labelEl.textContent = label;

      // ğŸ”µ Normal Range ì•ˆì—ì„œ ë‚´ ìœ„ì¹˜ ê³„ì‚°
      const normalMin = 50;   // ë§¤ìš° ë„“ê²Œ ì¡ì€ 'ì •ìƒ' ë²”ìœ„
      const normalMax = 120;
      const range = normalMax - normalMin;

      const clamped = Math.max(normalMin, Math.min(normalMax, bpm));
      let t = (clamped - normalMin) / range;         // 0~1
      const xLeft  = 20;   // SVGì—ì„œ ì™¼ìª½ ê²½ê³„ì„  x
      const xRight = 100;   // ì˜¤ë¥¸ìª½ ê²½ê³„ì„  x
      const x = xLeft + t * (xRight - xLeft);        // í•­ìƒ ë‘ ì„  ì•ˆì— ìœ„ì¹˜

      if (nrMarkerLine && nrMarkerDot && nrBpmInline && nrMarkerLabel) {
        nrMarkerLine.setAttribute('x1', x);
        nrMarkerLine.setAttribute('x2', x);
        nrMarkerDot.setAttribute('cx', x);
        nrMarkerLabel.setAttribute('x', x);
        nrBpmInline.textContent = `${bpm} bpm`;
      }
    }



    // ë‹¤ì‹œ ì‹œì‘
    btnRestart.onclick = () => {
      answers = { politics:null, gender:null, identity:null };
      document.querySelectorAll('.opt').forEach(o => o.classList.remove('selected'));

      if (scanAnimFrame) cancelAnimationFrame(scanAnimFrame);
      scanPercentEl.textContent = "Requesting camera permissionâ€¦";
      camWrap.style.animationDuration = "1.1s";
      stopPPG();
      stopCamera();
      signalStatusEl.textContent = "";
      show(q1);
    };
  </script>
</body>
</html>
